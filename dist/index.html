<!DOCTYPE html><html lang="en"><head><title>BACK</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="mobile-web-app-capable" content="yes"><style type="text/css">body,html{width:100%;height:100%;margin:0;padding:0;overflow:hidden;background-color:#000;color:#fff}#hud{display:flex;justify-content:space-around;width:100%;background:rgba(0,0,0,.7)}#game,#hud{position:absolute}#game{top:0;left:0;height:100%;cursor:crosshair;image-rendering:optimizeSpeed;image-rendering:-moz-crisp-edges;image-rendering:-o-crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:pixelated}#config{position:absolute;top:30px}</style></head><body><canvas id="game" height="256"></canvas><div id="hud"><div>HP: <span></span></div><div>Grenade: <span></span></div><div>Score: <span></span></div></div><script src="map.js"></script><script type="text/javascript">!function(t){var e={};function s(i){if(e[i])return e[i].exports;var h=e[i]={i:i,l:!1,exports:{}};return t[i].call(h.exports,h,h.exports,s),h.l=!0,h.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)s.d(i,h,function(e){return t[e]}.bind(null,h));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=4)}([function(t,e,s){},function(t){t.exports=JSON.parse('{"cam":{"spd":0.02},"map":{"cave":[1,2,3,4,0],"sgmt":[[[[5],[1,1,11],[2,4,8]]],[[[1,1,11],[11]],[[2,4,3],[3,0,11,1,11,2,11],[4,8,3],[6,11,11]]],[[[4,3,12],[6,3,9],[4,0,9]],[[2,10,2]]],[[[6],[4,0,4,8,12]]],[[[6],[3,0,2,4,8,10,12]]]]},"hero":{"x":96,"y":128,"hp":100,"spd":0.07,"score":0,"gun":{"frq":80,"amm":9999,"mag":0,"bul":{"spd":0.4,"dmg":25,"size":6,"color":"#0ff"}},"gnd":{"frq":0,"amm":5,"mag":10,"bul":{"spd":0.2,"dmg":50,"size":10,"color":"#0f0","radius":48}}},"camp":{"hp":20,"dmg":5,"score":10},"shot":{"hp":50,"dmg":0,"score":50,"far":200,"gun":{"frq":800,"amm":9999,"mag":0,"bul":{"spd":0.1,"dmg":10,"size":6,"color":"#fff"}}},"hole":{"frq":300,"limit":20,"near":180,"far":320},"runr":{"hp":10,"dmg":10,"spd":0.07,"score":25}}')},function(t,e){t.exports="data:image/png;base64,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"},function(t){t.exports=JSON.parse('{"cave":[0,0],"hero":[0,24],"font":[0,48],"item":[64,24],"splash":[112,24],"runner":[160,24],"camp":[192,24],"hole":[208,24],"plasma":[64,40],"shot":[217,40],"grenade":[224,24]}')},function(t,e,s){"use strict";s.r(e);s(0);window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;const i=new AudioContext,h={},r={},o=[];let n;var a,d,c={async init(){"suspended"===i.state&&await i.resume();const t=Math.pow(2,1/12);for(let e=-57;e<50;e++)o.push(440*Math.pow(t,e));const e=(n=i.createBuffer(1,88200,44100)).getChannelData(0);for(let t=0;t<88200;t++)e[t]=2*Math.random()-1},async sound(t,e,s,i){const h=new OfflineAudioContext(1,44100*i,44100),o=h.createGain(),a=Float32Array.from(s);if(o.connect(h.destination),e.curve&&o.gain.setValueCurveAtTime(e.curve,0,e.getTime(i)),h.addEventListener("complete",e=>r[t]=e.renderedBuffer),"custom"==e.type){const t=h.createBiquadFilter();t.connect(o),t.detune.setValueCurveAtTime(a,0,i);const e=h.createBufferSource();e.buffer=n,e.loop=!0,e.connect(t),e.start()}else{const t=h.createOscillator();t.type=e.type,t.frequency.setValueCurveAtTime(a,0,i),t.connect(o),t.start(),t.stop(i)}await h.startRendering()},async music(t,e){const s=e.reduce((t,e)=>e.length>t?e.length:t,0),i=new OfflineAudioContext(1,44100*s,44100);i.addEventListener("complete",e=>r[t]=e.renderedBuffer),e.forEach((t,e)=>t.play(i)),await i.startRendering()},mixer:t=>(t in h||(h[t]=i.createGain(),h[t].connect(i.destination)),h[t]),play(t,e=!1,s="master"){if(t in r){let h=i.createBufferSource();return h.loop=e,h.buffer=r[t],h.connect(this.mixer(s)),h.start(),h}return null}};function l(t,e){return(e||document).querySelector(t)}function p(t,e,s,i=!1){t.addEventListener(e,s,i)}class u{static get(t=1,e=0,s=!0){if(t<=e)return t;u.seed=(9301*u.seed+49297)%233280;let i=e+u.seed/233280*(t-e);return s?Math.round(i):i}}u.seed=Math.random(),function(t){t[t.FIRE=0]="FIRE",t[t.ALT=2]="ALT",t[t.LEFT=65]="LEFT",t[t.RIGHT=68]="RIGHT",t[t.UP=87]="UP",t[t.DOWN=83]="DOWN"}(a||(a={}));class m{constructor(t=0,e=0){this.x=t,this.y=e}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get angle(){return Math.atan2(this.y,this.x)}set(t,e=t){return t instanceof m?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this}add(t,e=t){return t instanceof m?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=e),this}sub(t,e=t){return t instanceof m?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=e),this}scale(t){return this.x*=t,this.y*=t,this}tile(t){return new m(Math.floor(this.x/t),Math.floor(this.y/t))}invert(){return this.x=-this.x,this.y=-this.y,this}normalize(){const t=this.length;return t>0&&this.scale(1/t),this}clone(){return new m(this.x,this.y)}}class f{constructor(t,e,s=e){this.pos=t,this.width=e,this.height=s,this._center=new m}get center(){return this._center.set(this.width/2+this.pos.x,this.height/2+this.pos.y),this._center}collide({pos:t,width:e,height:s}){return this.pos.x<t.x+e&&this.pos.x+this.width>t.x&&this.pos.y<t.y+s&&this.height+this.pos.y>t.y}contains({pos:t,width:e,height:s}){return this.pos.x<=t.x&&this.pos.x+this.width>=t.x+e&&this.pos.y<=t.y&&this.pos.y+this.height>=t.y+s}intersect({pos:t,width:e,height:s}){let i=Math.round(this.pos.x),h=Math.round(this.pos.y),r=i+this.width,o=h+this.height,n=Math.round(t.x),a=Math.round(t.y),d=n+e,c=a+s,l=i<n?n:i,p=h<a?a:h,u=r<d?r:d,g=o<c?o:c;return new f(new m(l,p),u-l,g-p)}}class g{constructor(t,e=null,s=null,i=!0){this.type=t,this.target=e,this.payload=s,this.bubble=i,this.stoped=!1}stop(){this.stoped=!0}}class x{constructor(){this.children=[],this.listeners={all:[]}}addChild(t){return this.children.push(t),t.parent=this,this}removeChild(t){const e=this.children.indexOf(t);e>=0&&(this.children.splice(e,1),t.parent=null)}each(t){for(let e=this.children.length-1;e>=0;e--)t(this.children[e],e)}on(t,e){const s=t.match(/[a-zA-Z]+/g);s&&s.forEach(t=>{t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push(e)})}emit(t){for(const e of this.listeners.all){if(t.stoped)return;e(t)}if(t.type in this.listeners)for(const e of this.listeners[t.type]){if(t.stoped)return;e(t)}t.bubble&&this.parent&&this.parent.emit(t)}render(t){this.children.forEach(e=>e.render(t))}update(t){this.children.forEach(e=>e.update(t))}}class w extends x{constructor(t){super(),this.factory=t,this.pool=[]}create(t=null){let e=this.pool.pop();return e||(e=this.factory()),this.addChild(e),t&&t(e),e}removeChild(t){super.removeChild(t),this.pool.push(t)}}class y extends w{constructor(t,e,s,i=0,h=0){super(t),this.factory=t,this.init=e,this.box=s,this.frq=i,this.limit=h,this.pos=this.box.pos,this.time=0}create(t=null){return!this.limit||this.children.length<this.limit?super.create(t):null}update(t){super.update(t),this.frq<=0||(this.time+=t,this.time>this.frq&&(this.time-=this.frq,this.create(this.init)))}}class A{constructor(){}static load(t,e){return new Promise(s=>{const i=new Image;p(i,"load",()=>{A.image=i,A.config=e,s(i)}),i.src=t})}static draw(t,e,{pos:s,width:i,height:h},r=0,o=!1,n=!1){if(!(e in A.config))return;const a=A.config[e];t.save(),t.translate(Math.round(s.x),Math.round(s.y)),t.scale(o?-1:1,n?-1:1),t.drawImage(A.image,a[0]+r*i,a[1],i,h,o?-i:0,n?-h:0,i,h),t.restore()}}class b extends w{constructor(t,{frq:e,amm:s,mag:i}){super(t),this.factory=t,this.time=0,this.frq=e,this.ammo=s,this.magazine=i}load(t){this.ammo+=t,this.magazine&&this.ammo>this.magazine&&(this.ammo=this.magazine)}create(t=null){return this.ammo<=0||this.frq&&this.time?null:(this.ammo--,this.time=this.frq,super.create(t))}update(t){this.time=t<this.time?this.time-t:0,super.update(t)}}class v extends x{constructor({spd:t,dmg:e,size:s,color:i}={}){super(),this.time=0,this.spd=t,this.dmg=e,this.size=s,this.color=i,this.pos=new m,this.dir=new m,this.box=new f(this.pos,this.size)}render(t){let e=Math.floor(this.time%200/50);A.draw(t,"plasma",this.box,0,e%2>0,e>1)}update(t){this.time+=t,this.pos.add(this.dir.clone().scale(this.spd*t))}}class C extends v{constructor({spd:t,dmg:e,size:s,color:i,radius:h}={}){super({spd:t,dmg:e,size:s,color:i}),this.radius=h,this.aim=new m}render(t){A.draw(t,"grenade",this.box)}update(t){this.box.center.sub(this.aim).length<=this.spd*t?(this.pos.set(this.aim),this.emit(new g("explode",this)),this.parent.removeChild(this)):super.update(t)}}class M extends x{constructor({x:t,y:e,hp:s,spd:i,score:h,gun:r,gnd:o}={}){super(),this.dir=new m,this.aim=new m,this.fire=!1,this.time=0,this.hp=s,this.max=s,this.spd=i,this.score=h,this.pos=new m(t,e),this.box=new f(this.pos,16,24),this.gun=new b(()=>new v(r.bul),r),this.grenades=new b(()=>new C(o.bul),o),this.addChild(this.grenades),this.addChild(this.gun)}render(t){super.render(t);const e=this.aim.clone().sub(this.box.center);let s=e.y>=0?0:3,i=this.time%200,h=i<100;Math.abs(e.x)>Math.abs(e.y)&&(s=i<100?1:2,h=e.x>0),A.draw(t,"hero",this.box,s,h)}update(t){super.update(t),this.dir.length&&(this.time+=t),this.fire&&this.gun.create(t=>{const e=t.box,s=this.box.center;t.dir.set(this.aim.clone().sub(s).normalize()),t.pos.set(s.sub(e.width/2,e.height/2)),this.emit(new g("fire",this,t))})}launch(){this.grenades.create(t=>{const e=t.box,s=this.box.center;t.dir.set(this.aim.clone().sub(s).normalize()),t.pos.set(s.sub(e.width/2,e.height/2)),t.aim.set(this.aim),this.emit(new g("launch"))})}}!function(t){t[t.WALL=0]="WALL",t[t.GROUND=1]="GROUND",t[t.HOLE=2]="HOLE",t[t.CAMP=3]="CAMP",t[t.SHOT=4]="SHOT",t[t.WORM=5]="WORM",t[t.ITEM=6]="ITEM"}(d||(d={}));class O extends x{constructor(t){super(),this.name=t,this.size=16;const e=TileMaps[t];this.width=e.width+2,this.height=e.height+1,this.tiles=new Array(this.width*this.height).fill(d.WALL),e.layers[0].data.forEach((t,s)=>{let i=s%e.width+1,h=Math.floor(s/e.width)+1;this.tiles[h*this.width+i]=t>1?t:1-t}),this.loadFrames()}get length(){return this.width*this.height}loadFrames(){this.frame=[];for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++){let s=0;this.getTile(e,t)===d.WALL&&(s+=1,this.getTile(e,t-1)===d.WALL&&(s+=1),this.getTile(e-1,t)===d.WALL&&(s+=2),this.getTile(e+1,t)===d.WALL&&(s+=4),this.getTile(e,t+1)===d.WALL&&(s+=8)),this.frame.push(s)}}render(t){const e=new m,s=new f(e,this.size,1.5*this.size);let i=0;for(let h=0;h<this.height;h++){for(let r=0;r<this.width;r++)e.set(r,h).scale(this.size),A.draw(t,"cave",s,this.frame[i++]-1);e.x+=this.size}super.render(t)}setTile(t,e,s){e>=0&&e<this.height&&t>=0&&t<this.width&&(this.tiles[e*this.width+t]=s)}getTile(t,e){return e>=0&&e<this.height&&t>=0&&t<this.width?this.tiles[e*this.width+t]:d.WALL}getPosByTile(t){let e=0;const s=[];for(let i=0;i<this.height;i++)for(let h=0;h<this.width;h++)this.tiles[e++]===t&&s.push(new m(h*this.size,i*this.size));return s}collideX({pos:t,width:e,height:s},i=!1){let h=this.size,r=Math.floor(t.y/h),o=Math.floor(t.x/h),n=Math.floor((t.x+e)/h);for(let a=r*h;a<t.y+s;a+=h){let s=Math.floor(a/h);if(!this.getTile(o,s))return i&&(t.x+=(o+1)*h-t.x),!0;if(!this.getTile(n,s))return i&&(t.x-=t.x+e-n*h),!0}return!1}collideY({pos:t,width:e,height:s},i=!1){let h=this.size,r=Math.floor(t.y/h),o=Math.floor(t.x/h),n=Math.floor((t.y+s)/h);for(let a=o*h;a<t.x+e;a+=h){let e=Math.floor(a/h);if(!this.getTile(e,r))return i&&(t.y+=(r+1)*h-t.y),!0;if(!this.getTile(e,n))return i&&(t.y-=t.y+s-n*h),!0}return!1}createNav(t){const e=t.tile(this.size);this.nav=new Array(this.tiles.length).fill(O.MAX_NAV),this.setNav(e.x,e.y)}lockNav(t){const e=t.tile(this.size);this.nav[e.y*this.width+e.x]=O.MAX_NAV}setDirection(t){const e=this.size,s=t.box.center,i=s.tile(e);t.dir.set(0,0);let h=O.MAX_NAV;h=this.setDir(t,i,new m(1,0),h),h=this.setDir(t,i,new m(-1,0),h),h=this.setDir(t,i,new m(0,1),h),h=this.setDir(t,i,new m(0,-1),h),t.dir.x?(this.getTile(i.x,i.y+1)&&(h=this.setDir(t,i,new m(t.dir.x,1),h)),this.getTile(i.x,i.y-1)&&(h=this.setDir(t,i,new m(t.dir.x,-1),h))):t.dir.y&&(this.getTile(i.x+1,i.y)&&(h=this.setDir(t,i,new m(1,t.dir.y),h)),this.getTile(i.x-1,i.y)&&(h=this.setDir(t,i,new m(-1,t.dir.y),h))),t.dir.add(i).scale(e).add(e/2).sub(s).normalize()}setDir(t,e,s,i){const h=this.getNav(e.x+s.x,e.y+s.y);return i>h&&(t.dir=s,i=h),i}getNav(t,e){return e>=0&&e<this.height&&t>=0&&t<this.width?this.nav[e*this.width+t]:O.MAX_NAV}setNav(t,e,s=0){s>=O.MAX_NAV||!this.getTile(t,e)||s>=this.getNav(t,e)||(this.nav[e*this.width+t]=s++,this.setNav(t+1,e,s),this.setNav(t,e+1,s),this.setNav(t-1,e,s),this.setNav(t,e-1,s))}}O.MAX_NAV=30;class T extends x{constructor(t,{hp:e,dmg:s,score:i}={}){super(),this.hero=t,this.pos=new m,this.box=new f(this.pos,16),this.hp=e,this.max=e,this.dmg=s,this.score=i}update(t){if(super.update(t),this.box.collide(this.hero.box))return this.emit(new g("hit",this.hero,this.dmg)),void this.parent.removeChild(this);for(const t of this.hero.gun.children)if(this.box.collide(t.box))return this.emit(new g("hit",this,t.dmg)),void t.parent.removeChild(t)}}class E extends T{render(t){A.draw(t,"camp",this.box)}}class D extends T{constructor(t,{hp:e,dmg:s,score:i,far:h,gun:r}={}){super(t,{hp:e,dmg:s,score:i}),this.hero=t,this.far=h,this.gun=new b(()=>new v(r.bul),r),this.addChild(this.gun)}render(t){A.draw(t,"shot",this.box),super.render(t)}update(t){super.update(t),this.gun.each(t=>{t.box.collide(this.hero.box)&&(this.emit(new g("hit",this.hero,t.dmg)),t.parent.removeChild(t))});const e=this.box.center,s=this.hero.box.center.sub(e);s.length>this.far||this.gun.create(t=>{const i=t.box;t.dir.set(s.normalize()),t.pos.set(e.sub(i.width/2,i.height/2)),this.emit(new g("fire",t))})}}class L extends T{constructor(t,{hp:e,dmg:s,score:i,far:h,gun:r,spd:o}={}){super(t,{hp:e,dmg:s,score:i,far:h,gun:r}),this.hero=t,this.dir=new m,this.time=0,this.spd=o}render(t){let e=Math.floor(this.time%400/100);A.draw(t,"runner",this.box,e>1?3-e:e,e>1)}update(t){super.update(t),this.time+=t}}class N extends y{constructor(t,e,s,{frq:i,limit:h,near:r,far:o}){super(t,e,s,i,h),this.factory=t,this.init=e,this.box=s,this.active=!1,this.near=r,this.far=o}create(t=null){return this.active?super.create(t):null}toggle(t){const e=this.box.center.sub(t).length;e>this.far?this.active=!1:!this.active&&t.y>this.box.center.y&&e<this.near&&(this.active=!0,this.emit(new g("spawn",this)))}render(t){A.draw(t,"hole",this.box),super.render(t)}}class S extends x{constructor(t){super(),this.hero=t,this.hud=l("#hud").getElementsByTagName("span")}update(t){const e=this.hud,s=this.hero;e.item(0).innerText=s.hp.toString(),e.item(1).innerText=s.grenades.ammo.toString(),e.item(2).innerText=s.score.toString()}}class B extends x{constructor(t,e,s){super(),this.hero=t,this.value=e,this.color=s,this.pos=new m,this.box=new f(this.pos,10)}render(t){const e=this.box,s=this.pos;t.save(),t.fillStyle=this.color,t.fillRect(s.x+3,s.y+3,e.width,e.height),t.restore()}update(t){this.box.collide(this.hero.box)&&(this.power(),this.emit(new g("item",this)),this.parent.removeChild(this))}}class j extends B{power(){const t=this.hero;t.hp+=this.value,t.hp>t.max&&(t.hp=t.max)}}class z extends B{power(){this.hero.gun.load(this.value)}}class I extends B{power(){this.hero.grenades.load(this.value)}}var H=s(1);const Q=l("#game"),P=Q.getContext("2d"),q=new class extends x{constructor(){super(),this.hero=new M(H.hero),this.map=new O("map"),this.cam=new f(new m(0,-64),192,256),this.spd=H.cam.spd,this.aim=new m,this.camps=new w(()=>new E(this.hero,H.camp)),this.shots=new w(()=>new D(this.hero,H.shot)),this.holes=[],this.hero.pos.set(96,128),this.map.createNav(this.hero.box.center),this.addChild(this.map).addChild(this.camps).addChild(this.shots).addChild(this.hero).addChild(new S(this.hero));for(const t of this.map.getPosByTile(d.CAMP))this.camps.create(e=>e.pos.set(t));for(const t of this.map.getPosByTile(d.SHOT))this.shots.create(e=>e.pos.set(t));for(const t of this.map.getPosByTile(d.ITEM)){let e;switch(Math.floor(2.999*Math.random())){case 0:e=new j(this.hero,100,"#fff");break;case 1:e=new z(this.hero,200,"#0ff");break;case 2:e=new I(this.hero,5,"#0c0")}e.pos.set(t),this.addChild(e)}for(const t of this.map.getPosByTile(d.HOLE)){const e=new N(()=>new L(this.hero,H.runr),e=>e.pos.set(t),new f(t,16,16),H.hole);this.holes.push(e),this.addChild(e)}this.bind()}bind(){this.on("hit",t=>{const e=t.target;e instanceof T&&(e.hp-=t.payload,e.hp<=0&&(this.emit(new g("kill",e)),this.hero.score+=e.score,e.parent.removeChild(e),e.hp=e.max)),e instanceof M&&(e.hp-=t.payload,e.hp<0&&(e.hp=0))}),this.on("explode",t=>{const e=t.target;this.camps.each(t=>this.explode(e,t)),this.shots.each(t=>this.explode(e,t));for(const t of this.holes)t.each(t=>this.explode(e,t))})}explode(t,e){const s=t.box.center,i=e.box.center.sub(s).length;t.radius>=i&&this.emit(new g("hit",e,t.dmg))}render(t){t.save(),t.translate(Math.round(this.cam.pos.x),-Math.round(this.cam.pos.y)),super.render(t),t.restore()}update(t){super.update(t),this.updateHero(t),this.updateProjectile(t),this.updateMap(),this.updateSpawners(t);const e=this.cam,s=this.hero.box.center;this.cam.pos.y=s.y-.8*e.height}updateHero(t){const e=this.hero;e.dir.x&&(e.pos.x+=e.dir.x*e.spd*t,this.map.collideX(e.box,!0)),e.dir.y&&(e.pos.y+=e.dir.y*e.spd*t),this.map.collideY(e.box,!0);const s=this.cam;e.aim.set(this.aim).add(-s.pos.x,s.pos.y);const i=s.pos.y+s.height-e.pos.y-e.box.height;i<0&&(e.pos.y+=i)}updateProjectile(t){this.hero.gun.each(t=>{(this.map.collideX(t.box)||this.map.collideY(t.box))&&t.parent.removeChild(t)}),this.hero.grenades.each(t=>{(this.map.collideX(t.box)||this.map.collideY(t.box))&&(t.emit(new g("explode",t)),t.parent.removeChild(t))}),this.shots.each(t=>{t.gun.each(t=>{(this.map.collideX(t.box)||this.map.collideY(t.box))&&t.parent.removeChild(t)})})}updateMap(){this.map.createNav(this.hero.box.center);for(const t of this.holes)for(const e of t.children)this.map.lockNav(e.box.center)}updateSpawners(t){for(const e of this.holes){e.toggle(this.hero.pos);for(const s of e.children){this.map.setDirection(s);const e=s.spd*t;s.pos.add(s.dir.x*e,s.dir.y*e)}}}pointer(t,e){this.aim.set(t,e)}input(t,e){let s=0,i=0;t[a.LEFT]&&(s-=1),t[a.RIGHT]&&(s+=1),t[a.UP]&&(i-=1),t[a.DOWN]&&(i+=1),this.hero.dir.set(s,i).normalize(),this.hero.fire=!0===t[a.FIRE],t[a.ALT]&&e&&this.hero.launch()}},J=[];let X,k=!1;function W(){P.fillStyle="#999",P.fillRect(0,0,Q.width,Q.height),q.render(P)}function G(){const t=(new Date).getTime(),e=t-X;requestAnimationFrame(G),q.update(e<34?e:34),X=t,W()}function R(){const t=document.body;Q.width=Q.height/t.clientHeight*t.clientWidth,q.cam.pos.x=(Q.width-q.cam.width)/2}p(window,"load",async()=>{await A.load(s(2),s(3)),p(document,"contextmenu",t=>t.preventDefault()),R(),W(),p(document,"keydown",t=>{J[t.keyCode]=!0,q.input(J,!0)}),p(document,"keyup",t=>{J[t.keyCode]=!1,q.input(J,!1)}),p(Q,"mousedown",t=>{J[t.button]=!0,q.input(J,!0)}),p(Q,"mouseup",t=>{J[t.button]=!1,q.input(J,!1)}),p(Q,"mousemove",t=>{const e=document.body,s=Q.height/e.clientHeight;q.pointer(t.clientX*s,t.clientY*s)}),p(window,"resize",R)}),p(Q,"click",async()=>{k||(await c.init(),X=(new Date).getTime(),k=!0,G())})}]);</script></body></html>